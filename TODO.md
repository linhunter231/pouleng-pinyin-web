# 本地 ZIP 模式（纯前端）实施待办清单

> 目标：在浏览器中本地导入图片 ZIP 与 OCR JSON ZIP，匹配并编辑内容，保留上一页/下一页与叠加功能，最终将修改后的 JSON 重新打包为 ZIP 下载，整个流程不依赖服务器。

## 基础能力
- [ ] 集成解压库（优先 `JSZip`，可选 `unzipit`）
- [ ] 图片 ZIP 解压为 `Blob` → `URL.createObjectURL`
- [ ] JSON ZIP 解压为字符串 → `JSON.parse`
- [ ] 记录 `naturalWidth/naturalHeight` 以用于比例计算/渲染

## 文件匹配与索引
- [ ] 设计匹配键（默认取文件基名或其中的数字，如 `017`）
- [ ] 将图片条目和 JSON 条目按匹配键对齐，生成页面列表
- [ ] 处理 ZIP 含子目录的情况（统一提取路径末段文件名）
- [ ] 检测并提示不匹配项（缺图/缺 JSON/重复键）

## UI/交互
- [ ] 工具栏新增按钮：`导入图片 ZIP`、`导入 JSON ZIP`、`下载修改后的 JSON ZIP`
- [ ] 指示当前模式为“本地模式”，隐藏/禁用依赖后端的入口
- [ ] 保持 `上一页/下一页` 导航与图片叠加显示不变
- [ ] 大文件解压/索引显示进度或轻量 loading 提示

## 编辑行为（沿用/增强）
- [ ] 保持 `DetectedText / pageno / Confidence` 可编辑
- [ ] 键盘行为：`Shift+Enter` 插入换行；`Enter / Ctrl+Enter` 退出并保存
- [ ] 现有 z-index 与粘性工具栏视觉层级保持正确

## 本地保存
- [ ] 构造新的 JSON 内容（只替换/更新 `TextDetections` 等需改字段）
- [ ] 使用 `JSZip` 将所有更新后的 JSON 按原文件名写入 ZIP
- [ ] 触发下载（`Blob` + 隐藏 `<a download>`）
- [ ] 若支持 File System Access API，提供直接保存为增强选项

## 数据模型与校验
- [ ] 明确 `pageno` / `Confidence` 的类型与解析（数值或字符串）
- [ ] 编辑态与保存态的数据校验与清洗（去除不可见行、空白、非法字符）
- [ ] 保留原 JSON 其他字段，避免非编辑字段丢失

## 性能与内存
- [ ] 页面切换时对不再使用的图片 URL 调用 `URL.revokeObjectURL`
- [ ] 针对大 ZIP 做懒加载或分段处理（如果需要）
- [ ] 错误处理：解压失败、JSON 解析失败、对象 URL 生成失败

## 兼容性与降级
- [ ] Chrome/Edge：支持 File System Access API；Safari/Firefox：回退为下载 ZIP
- [ ] 支持 ZIP 内多层目录与不同命名风格（通过匹配规则适配）

## 配置与扩展
- [ ] 提供匹配规则配置（基名/数字提取/正则）
- [ ] 可选：手动修正映射界面（解决少量不一致文件）
- [ ] 可选：支持单页 JSON 的直接导出（便于局部校正）
- [ ] 可选：保留服务器模式切换，统一代码路径（本地/服务端）

## 验证与文档
- [ ] 使用示例 ZIP（多 PNG + 多 JSON）验证导入、匹配、导航、编辑、导出
- [ ] 编写使用说明（导入、匹配、编辑、保存、常见问题）

---

### 命名与结构约定（待确认）
- 默认匹配键：采用文件名中的“页号数字”或完整基名（示例：`017.png` ↔ `dic-017.json`）
- ZIP 结构：两者位于根目录；如含子目录，取路径末段文件名进行匹配
- 导出文件名：沿用原 JSON 文件名；整体 ZIP 命名 `ocr_json_updated.zip`

### 备注
- 整个流程在浏览器内完成，保护隐私，不上传任何文件到服务器。
- 若需将 `pageno` 存为字符串（而非数值），需调整保存逻辑及类型约束。